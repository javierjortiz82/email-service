services:
  # ==========================================================================
  # Email API Service
  # ==========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${SERVICE_NAME:-email-service}-api
    command: ["uvicorn", "email_service.api.main:app", "--host", "${API_HOST:-0.0.0.0}", "--port", "${API_PORT:-8000}"]
    ports:
      - "${API_PORT:-8000}:${API_PORT:-8000}"
    environment:
      - SERVICE_NAME=${SERVICE_NAME:-email-service}
      - SERVICE_VERSION=${SERVICE_VERSION:-1.0.0}
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-8000}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-mcp_user}:${POSTGRES_PASSWORD:-mcp_password}@mcp-postgres:5432/${POSTGRES_DB:-mcpdb}
      - SCHEMA_NAME=${SCHEMA_NAME:-test}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-Odiseo}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_TO_FILE=false
    volumes:
      - ./logs:/app/logs
    networks:
      - docker-config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${API_PORT:-8000}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================================================================
  # Email Worker Service
  # ==========================================================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${SERVICE_NAME:-email-service}-worker
    command: ["python", "-m", "email_service.worker"]
    environment:
      - SERVICE_NAME=${SERVICE_NAME:-email-service}
      - SERVICE_VERSION=${SERVICE_VERSION:-1.0.0}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-mcp_user}:${POSTGRES_PASSWORD:-mcp_password}@mcp-postgres:5432/${POSTGRES_DB:-mcpdb}
      - SCHEMA_NAME=${SCHEMA_NAME:-test}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-Odiseo}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}
      - EMAIL_WORKER_POLL_INTERVAL=${EMAIL_WORKER_POLL_INTERVAL:-10}
      - EMAIL_WORKER_BATCH_SIZE=${EMAIL_WORKER_BATCH_SIZE:-50}
      - EMAIL_RETRY_MAX_ATTEMPTS=${EMAIL_RETRY_MAX_ATTEMPTS:-3}
      - EMAIL_RETRY_BACKOFF_SECONDS=${EMAIL_RETRY_BACKOFF_SECONDS:-300}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_TO_FILE=true
      - LOG_DIR=/app/logs
    volumes:
      - ./logs:/app/logs
    networks:
      - docker-config
    restart: unless-stopped

networks:
  docker-config:
    external: true
